from flask import Blueprint
bp = Blueprint('campeur', __name__, url_prefix='/campeur')

@bp.route('/creation/campeur', methods=['POST'])
def creation_campeur():
    try:
        # Récupération des données JSON envoyées par le frontend
        data = request.json
        logger.info("Requête reçue pour la mise à jour d’un campeur : %s", data)

        # Extraction des champs nécessaires
        numero_emplacement = data.get('numero_emplacement')
        mot_de_passe = data.get('mot_de_passe')
        date_debut = data.get('date_debut')
        date_fin = data.get('date_fin')

        # Vérification que tous les champs sont présents
        if not all([numero_emplacement, mot_de_passe, date_debut, date_fin]):
            logger.warning("Requête incomplète : champs manquants.")
            return jsonify({'message': 'Tous les champs sont requis.'}), 400

        # On recherche le campeur via son identifiant (qui est ici le numéro d’emplacement)
        campeur = Campeur.query.filter_by(Identifiant=numero_emplacement).first()
        if not campeur:
            logger.warning(f"Campeur non trouvé avec identifiant : {numero_emplacement}")
            return jsonify({'message': f'Le campeur avec l’identifiant {numero_emplacement} n’existe pas.'}), 404

        # Mise à jour des informations du campeur : mot de passe haché + dates de séjour
        hashed_pw = bcrypt.generate_password_hash(mot_de_passe).decode('utf-8')
        campeur.Mot_de_passe = hashed_pw
        campeur.Date_Debut = datetime.strptime(date_debut, '%Y-%m-%d').date()
        campeur.Date_Fin = datetime.strptime(date_fin, '%Y-%m-%d').date()

        # Vérifie si l’emplacement existe
        emplacement = Emplacement.query.filter_by(Id_Emplacement=int(numero_emplacement)).first()
        if not emplacement:
            logger.warning(f"Emplacement non trouvé : Id_Emplacement={numero_emplacement}")
            return jsonify({'message': f"L'emplacement avec l'ID {numero_emplacement} n'existe pas."}), 404

        # Vérifie que l’emplacement n’est pas occupé par un autre campeur
        if emplacement.Id_Campeur and emplacement.Id_Campeur != campeur.Id_Campeur:
            logger.warning(f"Emplacement {numero_emplacement} déjà occupé par campeur {emplacement.Id_Campeur}")
            return jsonify({'message': f"L'emplacement {numero_emplacement} est déjà occupé."}), 409

        # Lier le campeur à l’emplacement
        emplacement.Id_Campeur = campeur.Id_Campeur
        emplacement.Numero_Emplacement = numero_emplacement

        # Sauvegarde des changements dans la base
        db.session.commit()
        logger.info(f"Mise à jour en base réussie pour campeur {campeur.Id_Campeur} et emplacement {numero_emplacement}")

        return jsonify({
            'message': 'Campeur mis à jour et lié à l’emplacement.',
            'Id_Campeur': campeur.Id_Campeur,
            'Identifiant': campeur.Identifiant,
            'Id_Emplacement': emplacement.Id_Emplacement
        }), 200

    except Exception as e:
        # En cas d'erreur, annule les changements en base
        db.session.rollback()
        logger.exception("Erreur lors de la mise à jour du campeur et de l’emplacement.")
        return jsonify({'message': f'Erreur : {str(e)}'}), 500

@bp.route('/consommation/eau/<identifiant>', methods=['GET'])
def consommation_eau_campeur(identifiant):
    logger.info("Requête reçue pour consulter la consommation d'eau du campeur avec identifiant : %s", identifiant)
    try:
        # Recherche de l’emplacement lié à l’identifiant (n° d’emplacement utilisé comme identifiant)
        emplacement = Emplacement.query.filter_by(Numero_Emplacement=identifiant).first()
        
        if not emplacement:
            logger.warning("Aucun emplacement trouvé pour l’identifiant %s", identifiant)
            return jsonify({'message': 'Aucun emplacement trouvé pour ce campeur.'}), 404

        # Récupération de toutes les consommations d’eau liées à cet emplacement
        consommations = ConsommationEau.query.filter_by(Id_Emplacement=emplacement.Id_Emplacement).all()
        logger.info("Nombre de consommations trouvées : %d", len(consommations))

        # Formatage des consommations pour affichage au format JSON
        resultats = [
            {
                'Id_Consommation_eau': c.Id_Consommation_eau,
                'Quantite': c.Quantite,
                'Date_Heure': c.Date_Heure.strftime('%Y-%m-%d %H:%M:%S')
            }
            for c in consommations
        ]

        return jsonify({'consommations': resultats}), 200

    except Exception as e:
        logger.exception("Erreur lors de la récupération des consommations d'eau pour l’identifiant : %s", identifiant)
        return jsonify({'message': f'Erreur serveur : {str(e)}'}), 500

@bp.route('/consommation/electricite/<identifiant>', methods=['GET'])
def consommation_electricite_campeur(identifiant):
    logger.info("Requête GET reçue pour la consommation électrique du campeur avec identifiant : %s", identifiant)
    try:
        # Recherche de l’emplacement lié à l’identifiant
        emplacement = Emplacement.query.filter_by(Numero_Emplacement=identifiant).first()
        
        if not emplacement:
            logger.warning("Aucun emplacement trouvé pour l’identifiant %s", identifiant)
            return jsonify({'message': 'Aucun emplacement trouvé pour ce campeur.'}), 404

        # Récupération des consommations électriques pour cet emplacement
        consommations = ConsommationElectrique.query.filter_by(Id_Emplacement=emplacement.Id_Emplacement).all()
        logger.info("Nombre de consommations électriques trouvées : %d", len(consommations))

        # Formatage des résultats pour la réponse JSON
        resultats = [
            {
                'Id_Consommation_electrique': c.Id_Consommation_electrique,
                'Quantite': c.Quantite,
                'Date_heure': c.Date_heure.strftime('%Y-%m-%d %H:%M:%S')
            }
            for c in consommations
        ]

        return jsonify({'consommations': resultats}), 200

    except Exception as e:
        logger.exception("Erreur lors de la récupération de la consommation électrique pour l’identifiant : %s", identifiant)
        return jsonify({'message': f'Erreur serveur : {str(e)}'}), 500


